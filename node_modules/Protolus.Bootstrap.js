//require.paths.push(__dirname);
require('MooTools').apply(GLOBAL);
require('Requests').apply(GLOBAL);
require('Midas.node').apply(GLOBAL);
require('Code').apply(GLOBAL);
GLOBAL.System = require('util');
GLOBAL.System.request = require('request');
GLOBAL.System.file = require('fs');
GLOBAL.System.url = require('url');
GLOBAL.System.uuid = require('node-uuid');
GLOBAL.System.querystring = require('querystring');
GLOBAL.System.dateFormat = require('dateformat');

var GLOBAL_ITEMS = function(){
	var items = [];
	for(var key in this) items.push(key);
	return items;
}();

(function(){
    this.Protolus = {
        resources : false,
        resourceDirectory : '',
        configurationDirectory : '',
        classDirectory : '',
        appName : 'Protolus',
        appVersion : 'a1',
        appColor : 'bright_green',
        errorColor : 'red+blink',
        appPort : 9876789,
        isNode : false,
        bootstrap : function(options){
            if (typeof module !== 'undefined' && module.exports){
                Protolus.isNode = true;
                Protolus.loadClass('Protolus', Protolus.resourceDirectory);
                Protolus.loadClass('Protolus.Registry', Protolus.resourceDirectory);
                Protolus.loadClass('Protolus.Resource', Protolus.resourceDirectory);
            }else{
                //clientside bootstrap
            }
        },
        loadClass : function(name, path){
            var file = (path || Protolus.classDirectory)+'/'+name+'.js';
            var body = System.file.readFileSync(file, 'utf8');
            try{
                if(path) eval.apply(GLOBAL, [body]);
                else{
                    if(!Data) throw('class loading requires the \'Data\' resource!');
                    eval.apply(GLOBAL, ['var '+name+' = '+body]);
                    eval.apply(GLOBAL, ['var protolus_data_dummy = new '+name+'();']);
                    eval.apply(GLOBAL, ['Data.dummies[\''+name+'\'] = protolus_data_dummy;']);
                    eval.apply(GLOBAL, [name+'.allfields = [\''+protolus_data_dummy.fields.combine(Data.coreFields).join("','")+'\'];'+name+'.fields = [\''+protolus_data_dummy.fields.join("','")+'\']; delete protolus_data_dummy;']);
                }
            }catch(ex){
                console.log('Error in File:'+file);
                throw(ex);
            }
        },
        addEvent : function(type, callback){
            switch(type){
                case 'web':
                    if(!Protolus.http) Protolus.http = require('http');
                    Protolus.http.createServer(callback).listen(Protolus.appPort);
                    break;
                case 'socket':
                    Protolus.socketIO = require('socket.io').listen(app);
                    Protolus.socketIO.set('log level', 1);
                    Protolus.socketIO.sockets.on('connection', callback);
                    break;
            }
        }
    };
})();

if (typeof exports != 'undefined') (function(){
    for (var key in this) if (!GLOBAL_ITEMS.contains(key)){
        exports[key] = this[key];
    }
    exports.apply = function(object){
        Object.append(object, exports);
    };
})();

